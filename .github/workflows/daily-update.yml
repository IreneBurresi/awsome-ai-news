name: Daily AI News Update

on:
  schedule:
    - cron: '0 8 * * *'  # Every day at 08:00 UTC
  workflow_dispatch:      # Allow manual trigger
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no commits/pushes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write         # Required for commits/pushes
  issues: write          # Required for creating issues on failure

jobs:
  update-news:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Cache pipeline cache
        uses: actions/cache@v4
        with:
          path: cache/
          key: pipeline-cache-${{ github.run_number }}
          restore-keys: |
            pipeline-cache-

      - name: Install dependencies
        run: uv sync

      - name: Run pipeline
        id: pipeline
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            uv run python -m src.main --dry-run
          else
            uv run python -m src.main
          fi

      - name: Commit and push changes
        if: ${{ success() && inputs.dry_run != 'true' }}
        run: |
          git config user.name "awesome-ai-news-bot"
          git config user.email "bot@github-actions"
          git add .
          git diff-index --quiet HEAD || git commit -m "chore: daily news update $(date +%Y-%m-%d)"
          git push

      # ========================================================================
      # NOTIFICATIONS ON FAILURE
      # ========================================================================

      - name: Create GitHub Issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Daily update failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Pipeline Failure Report

            **Run ID**: ${{ github.run_id }}
            **Run Number**: ${{ github.run_number }}
            **Timestamp**: ${new Date().toISOString()}
            **Triggered by**: ${{ github.event_name }}

            ### Details
            The daily news update pipeline failed during execution.

            ### Logs
            View the full logs here: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Action Required
            Please investigate the failure and fix any issues. The pipeline will retry tomorrow.

            ---
            *This issue was automatically created by GitHub Actions*`;

            // Check if there's already an open issue for today
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated,pipeline-failure'
            });

            const today = new Date().toISOString().split('T')[0];
            const existingIssue = issues.data.find(issue => issue.title.includes(today));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['automated', 'pipeline-failure', 'bug']
              });
            }

      - name: Send Telegram notification on failure
        if: failure() && secrets.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"ðŸš¨ *Awesome AI News Pipeline Failed*\n\n*Date*: $(date +%Y-%m-%d)\n*Run*: #${{ github.run_number }}\n\n[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
              \"parse_mode\": \"Markdown\",
              \"disable_web_page_preview\": true
            }"

      - name: Send Email notification on failure
        if: failure() && secrets.SENDGRID_API_KEY != ''
        run: |
          curl -X POST \
            "https://api.sendgrid.com/v3/mail/send" \
            -H "Authorization: Bearer ${{ secrets.SENDGRID_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"personalizations\": [{
                \"to\": [{\"email\": \"${{ secrets.ADMIN_EMAIL }}\"}],
                \"subject\": \"ðŸš¨ Awesome AI News Pipeline Failed - $(date +%Y-%m-%d)\"
              }],
              \"from\": {\"email\": \"noreply@github-actions.com\", \"name\": \"GitHub Actions Bot\"},
              \"content\": [{
                \"type\": \"text/html\",
                \"value\": \"<h2>Pipeline Failure Report</h2><p><strong>Date:</strong> $(date +%Y-%m-%d %H:%M:%S)</p><p><strong>Run Number:</strong> ${{ github.run_number }}</p><p><strong>Repository:</strong> ${{ github.repository }}</p><p><a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Full Logs</a></p><p>The daily news update pipeline failed. Please investigate and fix any issues.</p>\"
              }]
            }"

      # ========================================================================
      # NOTIFICATIONS ON SUCCESS
      # ========================================================================

      - name: Send Telegram notification on success
        if: success() && secrets.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"âœ… *Awesome AI News Updated*\n\n*Date*: $(date +%Y-%m-%d)\n*Run*: #${{ github.run_number }}\n\nDaily news successfully updated!\",
              \"parse_mode\": \"Markdown\"
            }"
